---
// Server tarafında çalışacak kod buraya
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCategories, getCategoryPostCounts } from '../lib/supabase';

const pageTitle = "İstanbul Bina Güçlendirme - Profesyonel CFRP ve Karbon Fiber Uygulamaları";
const description = "İstanbul ve çevresinde profesyonel bina güçlendirme, kolon, kiriş güçlendirme ve CFRP karbon fiber takviye hizmetleri. Depreme dayanıklı yapılar için bize ulaşın.";

// Kategori bilgilerini getirelim
const categories = await getCategories();
const categoryStats = await getCategoryPostCounts();

// Kategori ve post sayılarını birleştirelim
const categoriesWithCounts = categories.map(category => {
  const countInfo = categoryStats.find(c => c.id === category.id);
  return {
    ...category,
    postCount: countInfo ? countInfo.post_count : 0
  };
});

// Tüm kategorileri gösterelim, blog yazısı olmayan kategoriler de dahil
const sortedCategories = [...categoriesWithCounts].sort((a, b) => b.postCount - a.postCount);

// Schema.org yapılandırma verileri
const schemaData = {
  organization: {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "İstanbul Bina Güçlendirme",
    "url": Astro.site?.href || import.meta.env.SITE_URL || "",
    "logo": Astro.site 
      ? new URL("/favicon.svg", Astro.site).href 
      : "/favicon.svg",
    "description": description,
    "address": {
      "@type": "PostalAddress",
      "addressLocality": "İstanbul",
      "addressRegion": "İstanbul",
      "addressCountry": "TR"
    },
    "contactPoint": {
      "@type": "ContactPoint",
      "telephone": "+90-507-068-2946",
      "contactType": "customer service"
    },
    "sameAs": [
      "https://www.instagram.com/binaguclendirme/",
      "https://www.linkedin.com/company/binaguclendirme/"
    ]
  },
  
  website: {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "İstanbul Bina Güçlendirme",
    "url": Astro.site?.href || import.meta.env.SITE_URL || "",
    "potentialAction": {
      "@type": "SearchAction",
      "target": {
        "@type": "EntryPoint",
        "urlTemplate": (Astro.site?.href || import.meta.env.SITE_URL || "") + "/search?q={search_term_string}"
      },
      "query-input": "required name=search_term_string"
    }
  },
  
  localBusiness: {
    "@context": "https://schema.org",
    "@type": "LocalBusiness",
    "@id": (Astro.site?.href || import.meta.env.SITE_URL || "") + "#localBusiness",
    "name": "İstanbul Bina Güçlendirme",
    "image": [
      Astro.site 
        ? new URL("/images/building-reinforcement.jpg", Astro.site).href 
        : "/images/building-reinforcement.jpg"
    ],
    "priceRange": "₺₺₺",
    "telephone": "+90-507-068-2946",
    "address": {
      "@type": "PostalAddress",
      "addressLocality": "İstanbul",
      "addressRegion": "İstanbul",
      "addressCountry": "TR"
    },
    "geo": {
      "@type": "GeoCoordinates",
      "latitude": 41.0082,
      "longitude": 28.9784 
    },
    "openingHoursSpecification": [
      {
        "@type": "OpeningHoursSpecification",
        "dayOfWeek": [
          "Monday",
          "Tuesday",
          "Wednesday",
          "Thursday",
          "Friday"
        ],
        "opens": "09:00",
        "closes": "18:00"
      }
    ],
    "sameAs": [
      "https://www.instagram.com/binaguclendirme/",
      "https://www.linkedin.com/company/binaguclendirme/"
    ]
  }
};
---

<BaseLayout pageTitle={pageTitle} description={description}>
  <slot slot="head">
    <script is:inline type="application/ld+json" set:html={JSON.stringify(schemaData.organization)} />
    <script is:inline type="application/ld+json" set:html={JSON.stringify(schemaData.website)} />
    <script is:inline type="application/ld+json" set:html={JSON.stringify(schemaData.localBusiness)} />
  </slot>

  <div class="home-container">
    <p class="lead-text">İstanbul ve çevresinde bina güçlendirme hizmetleri sunuyoruz. CFRP ve Karbon Fiber uygulamalarında uzmanız.</p>
    
    <h2 class="section-title">Bölgelere Göre Hizmetlerimiz</h2>
    <div class="post-grid">
      {sortedCategories.map((category) => (
        <article class="post-card">
          <a href={`/kategori/${category.slug}`} 
             class="card-link"
             title={`${category.name} Bölgesi Bina Güçlendirme Hizmeti - ${category.postCount} Makale`}
             aria-label={`${category.name} bölgesinde bina güçlendirme hizmetlerimizi görüntüleyin - ${category.postCount} makale bulunuyor`}>
            <span class="visually-hidden">{category.name} bölgesi bina güçlendirme hizmeti</span>
            <div class="card-image">
              {category.featured_image ? (
                <img 
                  src={category.featured_image} 
                  alt={category.name}
                  width="400"
                  height="225"
                  loading="lazy"
                  decoding="async"
                  fetchpriority="high"
                  sizes="(max-width: 768px) 100vw, 400px"
                  onerror="this.onerror=null; this.src=this.src.replace(/\.\w+$/, '.jpg');"
                />
              ) : (
                <div class="placeholder-image">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="64" height="64" aria-labelledby="imgTitle" role="img">
                    <title id="imgTitle">{category.name} Bina Güçlendirme Görseli</title>
                    <path fill="currentColor" d="M19,3H5C3.9,3,3,3.9,3,5v14c0,1.1,0.9,2,2,2h14c1.1,0,2-0.9,2-2V5C21,3.9,20.1,3,19,3z M19,19H5V5h14V19z M13.96,12.29l-2.75,3.54l-1.96-2.36L6.5,17h11L13.96,12.29z"/>
                  </svg>
                </div>
              )}
            </div>
            <div class="card-content">
              <h2>{category.name}</h2>
              {category.description && (
                <p class="post-excerpt">{category.description}</p>
              )}
              <p class="post-count"><span>{category.postCount}</span> makale</p>
              <span class="read-more">{category.name.replace("Bina Güçlendirme", "Karbon Fiber ile Güçlendirme")} →</span>
            </div>
          </a>
        </article>
      ))}
    </div>

    <!-- Şirket bilgisi, hizmet veren kişinin/kurumun resmi bilgilerini içermeli -->
    <section class="company-info">
      <h2>İstanbul Bina Güçlendirme</h2>
      <div class="company-content">
        <div class="company-text">
          <p>
            İstanbul ve çevresinde binaların depreme karşı güçlendirilmesi, karbon fiber, CFRP uygulamaları ve 
            yapısal takviye hizmetleri sunuyoruz. Uzman ekibimizle, İstanbul'un her bölgesinde hizmet veriyoruz.
          </p>
          <p>
            <strong>İletişim:</strong> +90-507-068-2946<br>
            <strong>E-posta:</strong> info@binaguclendirme.com<br>
            <strong>Adres:</strong> İstanbul, Türkiye
          </p>
          <div class="social-links">
            <a href="https://www.instagram.com/binaguclendirme/" target="_blank" rel="noopener noreferrer">Instagram</a>
            <a href="https://www.linkedin.com/company/binaguclendirme/" target="_blank" rel="noopener noreferrer">LinkedIn</a>
          </div>
        </div>
      </div>
    </section>
  </div>

  <style>
    /* Sayfa başlık stili */
    .home-container {
      width: 100%;
      padding: 0 1rem;
    }
    
    .lead-text {
      font-size: 1.15rem;
      color: var(--color-text-light);
      line-height: 1.5;
      margin-bottom: 1.5rem;
      margin-top: 1.5rem;
    }
    
    .section-title {
      margin-bottom: 2rem;
      font-size: 1.6rem;
      color: var(--color-text);
      font-weight: 600;
    }
    
    /* Şirket Bilgisi Bölümü */
    .company-info {
      margin-top: 4rem;
      padding: 2rem;
      background-color: var(--color-grey-light);
      border-radius: var(--radius-sm);
    }
    
    .company-info h2 {
      margin-top: 0;
      margin-bottom: 1.5rem;
      color: var(--color-text);
      font-size: 1.6rem;
      font-weight: 600;
    }
    
    .company-content {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    
    .company-text p {
      margin-bottom: 1rem;
    }
    
    .company-text strong {
      color: var(--color-text);
    }
    
    .social-links {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .social-links a {
      display: inline-block;
      padding: 0.5rem 1rem;
      background-color: var(--color-primary-light);
      color: var(--color-primary);
      text-decoration: none;
      border-radius: var(--radius-sm);
      transition: background-color 0.2s ease;
    }
    
    .social-links a:hover {
      background-color: var(--color-primary);
      color: white;
    }
    
    /* Duyarlı tasarım */
    @media (max-width: 768px) {
      .post-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1.5rem;
      }
      
      .section-title, .company-info h2 {
        font-size: 1.4rem;
      }
      
      .home-container {
        padding: 0 1.25rem;
      }
    }
    
    @media (max-width: 480px) {
      .post-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }
      
      .section-title, .company-info h2 {
        font-size: 1.3rem;
      }
      
      .lead-text {
        font-size: 1rem;
      }
      
      .company-info {
        padding: 1.5rem;
      }
    }
  </style>
</BaseLayout>
