---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getBlogPostBySlug, getCategories } from '../../lib/supabase';
import { parseMarkdown } from '../../lib/markdown';

// Dinamik rota parametresini al
const { slug } = Astro.params;

// İlgili blog yazısını getir
const post = await getBlogPostBySlug(slug);

// Blog yazısı bulunamadıysa hata sayfasına yönlendir
if (!post) {
  return Astro.redirect('/404');
}

// Kategori bilgisini alalım
const categories = await getCategories();
const category = categories.find(cat => cat.id === post.category_id);

// FAQ için bir arayüz tanımlayalım
interface FaqItem {
  question: string;
  answer: string;
}

// İçeriği markdown'dan HTML'e dönüştür
const contentHtml = parseMarkdown(post.content);

// FAQ verilerini işleme fonksiyonu
function processFaqData(faqData: any[]): FaqItem[] {
  if (!faqData || !Array.isArray(faqData) || faqData.length === 0) {
    return [];
  }
  
  return faqData.filter(item => 
    item && typeof item === 'object'
  ).map(item => ({
    question: item.question || item.Question || item.soru || item.Soru || '',
    answer: item.answer || item.Answer || item.cevap || item.Cevap || ''
  })).filter(item => item.question && item.answer);
}

// FAQ verilerini işle
const processedFaq = processFaqData(post.faq) || processFaqData(post.sss) || [];
const hasFaq = processedFaq.length > 0;

const pageTitle = post.title;
const description = post.meta_description;
---

<BaseLayout pageTitle={pageTitle} description={description}>
  <slot slot="head">
    <meta name="keywords" content={post.keywords ? post.keywords.join(', ') : ''} />
  </slot>

  <article>
    <div class="post-header">
      <h1 class="post-title">{post.title}</h1>
      <div class="post-meta">
        <div>
          {category && (
            <a href={`/kategori/${category.slug}`} class="post-category">
              {category.name}
            </a>
          )}
          <span>Tarih: {new Date(post.created_at).toLocaleDateString('tr-TR')}</span>
        </div>
      </div>
      
      {post.featured_image && (
        <img 
          src={post.featured_image} 
          alt={post.title} 
          class="featured-image"
          loading="lazy"
        />
      )}
    </div>
    
    <div class="post-content">
      <div set:html={contentHtml} />
    </div>
    
    {hasFaq && (
      <div class="faq-section">
        <h2>Sık Sorulan Sorular</h2>
        {processedFaq.map((item: FaqItem) => (
          <div class="faq-item">
            <div class="faq-question">{item.question}</div>
            <div class="faq-answer" set:html={parseMarkdown(item.answer)} />
          </div>
        ))}
      </div>
    )}
  </article>
</BaseLayout>

<style>
  .post-header {
    margin-bottom: 30px;
  }
  
  .post-title {
    margin-bottom: 10px;
    font-size: 2rem;
    color: var(--color-text);
  }
  
  .post-meta {
    display: flex;
    justify-content: space-between;
    color: var(--color-text-light);
    font-size: 0.9rem;
    margin-bottom: 20px;
  }
  
  .post-category {
    background-color: var(--color-primary-light);
    display: inline-block;
    padding: 3px 8px;
    border-radius: var(--radius-sm);
    margin-right: 10px;
  }
  
  .featured-image {
    width: 100%;
    max-height: 400px;
    object-fit: cover;
    border-radius: var(--radius-sm);
    margin-bottom: 20px;
  }
  
  /* İçerik stilleri */
  .post-content {
    margin-bottom: 30px;
  }
  
  .post-content h2 {
    margin-top: 1.5em;
    margin-bottom: 0.5em;
    font-size: 1.6rem;
    color: var(--color-text);
  }
  
  .post-content h3 {
    margin-top: 1.2em;
    margin-bottom: 0.5em;
    font-size: 1.4rem;
    color: var(--color-text);
  }
  
  .post-content p, .post-content ul, .post-content ol {
    margin-bottom: 1em;
    color: var(--color-text);
  }
  
  .post-content ul, .post-content ol {
    padding-left: 2em;
  }
  
  .post-content blockquote {
    border-left: 4px solid var(--color-border-dark);
    padding-left: 1em;
    margin: 0 0 1em 0;
    font-style: italic;
    color: var(--color-text-light);
  }
  
  .post-content pre {
    background-color: var(--color-grey-light);
    padding: 1em;
    border-radius: var(--radius-sm);
    overflow-x: auto;
  }
  
  .post-content code {
    background-color: var(--color-grey-light);
    padding: 0.2em 0.4em;
    border-radius: var(--radius-sm);
    font-family: monospace;
  }
  
  /* FAQ stilleri */
  .faq-section {
    margin-top: 40px;
    background-color: var(--color-grey-light);
    padding: 20px;
    border-radius: var(--radius-sm);
  }
  
  .faq-item {
    margin-bottom: 20px;
  }
  
  .faq-question {
    font-weight: bold;
    margin-bottom: 5px;
    color: var(--color-text);
  }
  
  .faq-answer {
    margin-left: 1em;
    color: var(--color-text);
  }
</style> 